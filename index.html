<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç‰ˆï¼‰</title>
  <style>
   body {
  font-family: "Rounded Mplus 1c", "Hiragino Maru Gothic ProN", sans-serif;
  background: #fff0f6; /* æ·¡ã„ãƒ”ãƒ³ã‚¯èƒŒæ™¯ */
  color: #444;
}

h1, h2 {
  margin: 8px 0;
  color: #ff69b4; /* ãƒãƒƒãƒ—ãªãƒ”ãƒ³ã‚¯ */
  text-shadow: 1px 1px #ffcce0;
}

.wrap {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.panel {
  background: #ffffff;
  border: 2px solid #ffd6e7;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 4px 4px 8px rgba(255, 182, 193, 0.4);
}

.subpanel {
  background: #fffafc;
  border: 1px dashed #ffb6c1;
  border-radius: 12px;
  padding: 10px;
  margin-top: 10px;
}

.row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.btn {
  padding: 8px 10px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, #ffb6c1, #ff69b4);
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s, background 0.3s;
}
.btn:hover {
  transform: scale(1.05);
  background: linear-gradient(135deg, #ff69b4, #ff85c1);
}

.btn.primary {
  background: linear-gradient(135deg, #87cefa, #00bfff);
}
.btn.primary:hover {
  background: linear-gradient(135deg, #00bfff, #1e90ff);
}

.btn.warn {
  background: linear-gradient(135deg, #ffe066, #ffcc00);
  color: #333;
}
.btn.warn:hover {
  background: linear-gradient(135deg, #ffcc00, #ff9900);
}

.btn.danger {
  background: linear-gradient(135deg, #ff6b6b, #ff0000);
}
.btn.danger:hover {
  background: linear-gradient(135deg, #ff0000, #cc0000);
}

.input {
  background: #fff;
  color: #444;
  border: 1px solid #ffb6c1;
  border-radius: 12px;
  padding: 6px 10px;
}

.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.table th, .table td {
  border-bottom: 1px solid #ffd6e7;
  padding: 6px;
  text-align: left;
}

.avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 3px solid #ffb6c1;
  object-fit: cover;
  box-shadow: 2px 2px 6px rgba(255, 105, 180, 0.5);
}

.pill {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  background: #ffe6f0;
  border: 1px solid #ffb6c1;
  margin-left: 6px;
  color: #ff69b4;
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(255, 182, 193, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.modal-box {
  width: min(800px, 95vw);
  background: #fff;
  color: #444;
  border-radius: 20px;
  padding: 20px;
  border: 2px solid #ffb6c1;
  box-shadow: 6px 6px 12px rgba(255, 182, 193, 0.5);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  border: 1px solid #ffb6c1;
  background: #ffe6f0;
  color: #ff69b4;
}
.tag.vip {
  background: #fffacd;
  border: 1px solid #ffd700;
  color: #b8860b;
}

.muted { color: #999; }
.ok { color: #2a6; }
.bad { color: #c33; }
.scroll { max-height: 330px; overflow: auto; }
.hint { font-size: 12px; color: #999; }

.mute-button {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 1000; /* ä»–ã®è¦ç´ ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
  padding: 8px 15px;
  background-color: rgba(0, 0, 0, 0.6);
  color: white;
  border: 1px solid white;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s;
}

.mute-button:hover {
  background-color: rgba(50, 50, 50, 0.8);
}

/* ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã®æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰ */
.mute-button.is-muted {
  color: #ff4444;
  border-color: #ff4444;
}

  </style>
</head>
<body>

<div class="wrap">
  <h1>ã‚¬ãƒ¼ãƒ«ã‚ºãƒãƒ¼çµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç‰ˆï¼‰</h1>

  <div class="grid">
    <!-- å·¦ï¼šæ˜¼ãƒ•ã‚§ãƒ¼ã‚ºè¨­å®š -->
    <div class="panel">
      <h2>æ˜¼ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæº–å‚™ï¼‰</h2>
      <div class="row">
        <div>é€±: <span id="uiWeek">1</span></div>
        <div>è³‡é‡‘: <span id="uiFunds">Â¥100,000</span></div>
        <div>ç´¯è¨ˆå£²ä¸Š: <span id="uiTotal">Â¥0</span></div>
        <div>ãƒ©ãƒ³ã‚¯: <span id="uiRank">æ ¼å®‰</span> <span class="pill" id="uiRep">è©•åˆ¤ 20</span> <span class="pill" id="uiPop">çŸ¥ååº¦ 30</span></div>
      </div>

      <div class="subpanel">
        <h3>åºƒå‘Šé¸æŠ</h3>
        <div class="row">
          <select id="adSelect" class="input">
            <option value="none">ãªã—ï¼ˆÂ¥0ï¼‰</option>
            <option value="sns">SNSï¼ˆÂ¥5,000ï¼æ¥å®¢å¾®å¢—ï¼‰</option>
            <option value="event">åœ°åŸŸã‚¤ãƒ™ãƒ³ãƒˆï¼ˆÂ¥15,000ï¼æ¥å®¢â†‘ï¼‰</option>
            <option value="mag">é›‘èªŒæ²è¼‰ï¼ˆÂ¥30,000ï¼æ¥å®¢â†‘â†‘ï¼‹çŸ¥ååº¦UPï¼‰</option>
          </select>
          <span class="hint">ä»Šé€±ã®æ¥å®¢ã«å½±éŸ¿ã—ã¾ã™</span>
        </div>
      </div>

      <div class="subpanel">
        <h3>æ•™è‚²ï¼ˆèƒ½åŠ›å¾®å¢—ãƒ»è²»ç”¨ãƒ»ç–²åŠ´å¢—ï¼‰</h3>
        <div class="row">
          <select id="trainTarget" class="input"></select>
          <select id="trainStat" class="input">
            <option value="aisou">æ„›æƒ³(AI)</option>
            <option value="kaiwa">ä¼šè©±(TK)</option>
            <option value="attentiveness">æ°—é£ã„(CA)</option>
          </select>
          <input type="number" id="trainBudget" class="input" value="5000" min="0" step="1000" />
          <button class="btn" id="btnTrain">æ•™è‚²å®Ÿè¡Œ</button>
          <span class="hint">è²»ç”¨=ä¸Šæ˜‡å¹…ã®ç›®å®‰ã€‚ç–²åŠ´+10</span>
        </div>
      </div>

      <div class="subpanel">
        <h3>æ¡ç”¨ï¼ˆè²»ç”¨ã«å¿œã˜ã¦å€™è£œå“è³ªUPï¼‰</h3>
        <div class="row">
          <input type="number" id="hireBudget" class="input" value="20000" min="0" step="5000" />
          <button class="btn" id="btnGenCandidates">å€™è£œç”Ÿæˆ</button>
        </div>
        <div id="hireCandidates" class="scroll"></div>
      </div>

      <div class="subpanel">
        <h3>ã‚·ãƒ•ãƒˆ</h3>
        <div class="row">
          <span class="hint">æœ€ä½1äººã¯å‡ºå‹¤ã€‚ä¼‘ã¿â†’å‡ºå‹¤åˆ‡æ›¿æ™‚ã¯ã‚¹ãƒˆãƒ¬ã‚¹+50</span>
        </div>
        <div id="shiftList" class="scroll"></div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn primary" id="btnStartNight">å¤œãƒ•ã‚§ãƒ¼ã‚ºã¸</button>
      </div>
    </div>

    <!-- å³ï¼šã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã¨çµæœ -->
    <div class="panel">
      <h2>ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§</h2>
      <div id="castList" class="scroll"></div>

      <div class="subpanel" style="margin-top:12px;">
        <h3>å‰é€±ã®çµæœãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <div id="phaseResult" class="phase" style="display:none;">
  <div id="report"></div>
</div>
      </div>
    </div>
  </div>

  <!-- å¤œãƒ•ã‚§ãƒ¼ã‚ºï¼šæ¥å®¢æ³¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="waveModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2>å¤œãƒ•ã‚§ãƒ¼ã‚ºï¼šæ¥å®¢æ³¢ <span id="waveIndex">1</span>/<span id="waveTotal">5</span></h2>
        <span class="tag" id="waveRankTag">æ ¼å®‰</span>
      </div>
      <p class="muted">å®¢ã‚¿ã‚¤ãƒ—ãƒ»è¦æ±‚ã«åˆã‚ã›ã¦ã‚­ãƒ£ã‚¹ãƒˆã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚æœªé…ç½®ã§ã‚‚é€²è¡Œå¯èƒ½ã§ã™ãŒã€è©•åˆ¤ãŒä¸‹ãŒã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
      <div id="waveCustomers" class="scroll"></div>
      <div class="subpanel">
        <h3>å‡ºå‹¤ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰é…ç½®</h3>
        <div id="assignArea" class="scroll"></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnResolveWave">ã“ã®æ³¢ã‚’å‡¦ç†</button>
        <button class="btn warn" id="btnSkipAssign">æœªé…ç½®ã®ã¾ã¾é€²ã‚ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒ©ãƒ–ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="troubleModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2>ãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿï¼</h2>
        <button class="btn" id="btnCloseTrouble">é–‰ã˜ã‚‹</button>
      </div>
      <div id="troubleBody"></div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" data-choice="strong" id="troubleStrong">å¼·æ°—ã§å‡ºç¦ï¼ˆæ¨å¥¨:TKï¼‰</button>
        <button class="btn" data-choice="calm" id="troubleCalm">è½ã¡ç€ã„ã¦é€€åº—ï¼ˆæ¨å¥¨:AIï¼‰</button>
        <button class="btn" data-choice="warn" id="troubleWarn">æ³¨æ„å¯¾å¿œï¼ˆæ¨å¥¨:CAï¼‰</button>
      </div>
      <div id="troubleResult" style="margin-top:6px;"></div>
    </div>
  </div>

<!-- é€±å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="weekReportModal" style="display:none;">
  <div id="weekReportBody"></div>
  <button onclick="closeWeekReport()">é–‰ã˜ã‚‹</button>
</div>


  <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="modal" id="endingModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2>ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</h2>
        <button class="btn" id="btnCloseEnding">é–‰ã˜ã‚‹</button>
      </div>
      <div id="endingSummary"></div>
      <h3>ã‚­ãƒ£ã‚¹ãƒˆçµæœä¸€è¦§</h3>
      <div id="endingCastList" class="scroll"></div>
      <div class="row" style="margin-top:8px;">
        <button class="btn primary" id="btnReset">ã‚‚ã†ä¸€åº¦éŠã¶ï¼ˆå®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼‰</button>
      </div>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ -->
  <div class="modal" id="gameoverModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
        <button class="btn" id="btnCloseGameover">é–‰ã˜ã‚‹</button>
      </div>
      <p>è³‡é‡‘ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚Šã¾ã—ãŸã€‚å–¶æ¥­ç¶™ç¶šä¸å¯ã§ã™ã€‚</p>
      <div id="gameoverCastList" class="scroll"></div>
      <div class="row" style="margin-top:8px;">
        <button class="btn primary" id="btnReset2">ã‚‚ã†ä¸€åº¦éŠã¶ï¼ˆå®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼‰</button>
      </div>
    </div>
  </div>

</div>

<div id="rareJoinModal" style="display:none;">
  <div id="rareJoinList"></div>
  <button onclick="closeRareJoinModal()">é–‰ã˜ã‚‹</button>
</div>


<button id="btnMute" class="mute-button" onclick="toggleMute()">
  ğŸµ BGM: ON
</button>

<script>
/* ===========
   GameState
   =========== */
const GameState = {
  week: 1,
  funds: 100000,
  totalSales: 0,
ã€€weekSales : 0,
  rankScore: 0, // å†…éƒ¨ãƒã‚¤ãƒ³ãƒˆ
  rank: "æ ¼å®‰",
  rep: 0,
  pop: 0,
  ad: "none",
  adCost: 0,
  adEffect: 0,
  casts: [],
  shifts: {}, // {castId: true/false} å‡ºå‹¤/ä¼‘ã¿
  waves: [],  // ä»Šé€±ã®æ¥å®¢æ³¢ç”Ÿæˆçµæœ
  waveCursor: 0,
  assignments: {}, // {waveIndex: {customerIndex: castId}}
  lastReport: null,
  ended: false
};

/* ===========
   BGMç®¡ç†
   =========== */
const mainBGM = new Audio("sounds/Romance.mp3"); 
mainBGM.loop = true;   // ãƒ«ãƒ¼ãƒ—å†ç”Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹
mainBGM.volume = 0.2;  // éŸ³é‡ã‚’40%ãã‚‰ã„ã«è¨­å®šï¼ˆãŠå¥½ã¿ã§ï¼‰

// å†ç”Ÿã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
function startBGM() {
  // play()ã¯Promiseã‚’è¿”ã™ã®ã§ã€å¿µã®ãŸã‚ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ã—ã¾ã™
  mainBGM.play().catch(error => {
    console.log("BGMã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ï¼‰:", error);
  });
}

// ç”»é¢ã®ã©ã“ã‹ã‚’1å›ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰BGMã‚’é–‹å§‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™å¯¾ç­–ï¼‰
window.addEventListener('click', () => {
  startBGM();
}, { once: true }); // once: true ã§1å›ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹


// åˆæœŸã‚­ãƒ£ã‚¹ãƒˆï¼ˆç”»åƒã¯å·®ã—æ›¿ãˆå‰æï¼‰
const initialCasts = [
  { id: "c1", name:"é‡ã€…èŠ±", img:"https://raw.githubusercontent.com/tanakanaka180-cloud/tanakanaka-index.html/refs/heads/main/syoki/nonoka.jpg",
    look:"ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«", nature:"æ˜ã‚‹ã„",
    aisou:60, kaiwa:50, attentiveness:65,
    fati:0, fatiMax:100, stress:0, stressMax:120,
    cond:"è‰¯å¥½", lv:1, exp:0, salary:10000, isInitial:true,joinweek:1 },
  { id: "c2", name:"ãƒ¢ã‚«", img:"images/character/syoki/moka.jpg",
    look:"ã‚¯ãƒ¼ãƒ«", nature:"å¤§äººã—ã„",
    aisou:55, kaiwa:65, attentiveness:50,
    fati:0, fatiMax:100, stress:0, stressMax:120,
    cond:"è‰¯å¥½", lv:1, exp:0, salary:10000, isInitial:true,joinweek:1 },
  { id: "c3", name:"ã‚†ãšã¿", img:"images/character/syoki/yuzumi.jpg",
    look:"ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼", nature:"ç©ã‚„ã‹",
    aisou:50, kaiwa:55, attentiveness:60,
    fati:0, fatiMax:100, stress:0, stressMax:120,
    cond:"è‰¯å¥½", lv:1, exp:0, salary:10000, isInitial:true,joinweek:1 }
];

// ãƒ¬ã‚¢ã‚­ãƒ£ã‚¹ãƒˆï¼ˆç”»åƒã¯å·®ã—æ›¿ãˆå‰æï¼‰
const RARE = {
  "ã‚«ãƒ¬ãƒ³": {id:"rare_karen", name:"ã‚«ãƒ¬ãƒ³", img:"images/character/rare/karen.jpg", aisou:90, kaiwa:75, attentiveness:80, fati:0, fatiMax:120, stress:0, stressMax:120, lv:5, exp:0, salary:18000, isInitial:false,joinWeek: GameState.week},
  "ãƒ¦ã‚º":   {id:"rare_yuzu",  name:"ãƒ¦ã‚º",   img:"images/character/rare/yuzu.jpg",  aisou:80, kaiwa:90, attentiveness:75, fati:0, fatiMax:120, stress:0, stressMax:120, lv:5, exp:0, salary:18000, isInitial:false,joinWeek: GameState.week},
  "ãƒ¬ã‚¤ãƒŠ": {id:"rare_reina", name:"ãƒ¬ã‚¤ãƒŠ", img:"images/character/rare/reina.jpg", aisou:85, kaiwa:80, attentiveness:90, fati:0, fatiMax:120, stress:0, stressMax:120, lv:5, exp:0, salary:18000, isInitial:false,joinWeek: GameState.week},
  "ãƒŸãƒŠ":   {id:"rare_mina",  name:"ãƒŸãƒŠ",   img:"images/character/rare/mina.jpg",  aisou:75, kaiwa:85, attentiveness:80, fati:0, fatiMax:120, stress:0, stressMax:120, lv:5, exp:0, salary:18000, isInitial:false,joinWeek: GameState.week},
  "ã‚¢ã‚ªã‚¤": {id:"rare_aoi",   name:"ã‚¢ã‚ªã‚¤", img:"images/character/rare/aoi.jpg",   aisou:80, kaiwa:80, attentiveness:85, fati:0, fatiMax:120, stress:0, stressMax:120, lv:5, exp:0, salary:18000, isInitial:false,joinWeek: GameState.week}
};

// ãƒ©ãƒ³ã‚¯æ®µéš
const RankSteps = ["æ ¼å®‰","å¤§è¡†","ä¸­ç´š","é«˜ç´š","ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸","V.I.P."];

/* ===========
   åˆæœŸåŒ–
   =========== */
function initGame() {
  GameState.week = 1;
  GameState.funds = 100000;
  GameState.totalSales = 0;
ã€€GameState.weekSales = 0;
  GameState.rep = 0;
  GameState.pop = 0;
  GameState.rankScore = 0;
  GameState.rank = "æ ¼å®‰";
  GameState.ad = "none";
  GameState.adCost = 0;
  GameState.adEffect = 0;
  GameState.casts = JSON.parse(JSON.stringify(initialCasts));
  GameState.shifts = {};
  GameState.waves = [];
  GameState.waveCursor = 0;
  GameState.assignments = {};
  GameState.lastReport = null;
  GameState.ended = false;
GameState.pendingRare = [];
GameState.perCastSales= []
  renderHeader();
  renderCastList();
  fillTrainTarget();
  rollShiftRandom();
  renderShiftList();
  document.getElementById("hireCandidates").innerHTML = "";
  document.getElementById("report").innerHTML = "<span class='muted'>å‰é€±ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</span>";
}
initGame();

/* ===========
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   =========== */
function yen(n){ return "Â¥" + Math.floor(n).toLocaleString(); }
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function renderHeader(){
  const remaining = 52 - GameState.week;
document.getElementById("uiWeek").textContent = `ç¬¬${GameState.week}é€± ï¼ æ®‹ã‚Š${remaining}é€±`;
  document.getElementById("uiFunds").textContent = yen(GameState.funds);
  document.getElementById("uiTotal").textContent = yen(GameState.totalSales);
  document.getElementById("uiRank").textContent = GameState.rank;
  document.getElementById("uiRep").textContent = `è©•åˆ¤ ${GameState.rep}`;
  document.getElementById("uiPop").textContent = `çŸ¥ååº¦ ${GameState.pop}`;
}

function toggleMute() {
  const btn = document.getElementById("btnMute");
  
  // mainBGMã¯å…ˆã»ã©ä½œæˆã—ãŸAudioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  if (mainBGM.muted) {
    // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤
    mainBGM.muted = false;
    btn.textContent = "ğŸµ BGM: ON";
    btn.classList.remove("is-muted");
  } else {
    // ãƒŸãƒ¥ãƒ¼ãƒˆè¨­å®š
    mainBGM.muted = true;
    btn.textContent = "ğŸ”‡ BGM: OFF";
    btn.classList.add("is-muted");
  }
}

// æ¬¡é€±ã®æ¥å®¢æ³¢ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function generateNextWeekWaves(rank){
  // ãƒ©ãƒ³ã‚¯ã«å¿œã˜ã¦æ¥å®¢æ•°ã‚„é›£æ˜“åº¦ã‚’èª¿æ•´ï¼ˆä¾‹ï¼šãƒ©ãƒ³ã‚¯ãŒä¸ŠãŒã‚‹ã»ã©å®¢æ•°å¢—åŠ ï¼‰
  let waveCount = 3; // åŸºæœ¬ã¯3æ³¢
  if(rank === "æ ¼å®‰") waveCount = 2;
  if(rank === "é«˜ç´š") waveCount = 4;

  const waves = [];
  for(let i=0; i<waveCount; i++){
    const customers = [];
    const custCount = randInt(2,5); // æ³¢ã”ã¨ã®å®¢æ•°ï¼ˆ2ã€œ5äººï¼‰

    for(let j=0; j<custCount; j++){
      customers.push({
        type: Math.random()<0.2 ? "VIP" : "ä¸€èˆ¬",
        reqStat: ["æ„›æƒ³","ä¼šè©±","æ°—é£ã„"][randInt(0,2)],
        reqVal: randInt(20,60),
        like: { look:"å¯æ„›ã„", nature:"æ˜ã‚‹ã„" }, // å¥½ã¿ã¯ç°¡æ˜“å›ºå®š
        basePrice: randInt(5000,15000),
        troubleRate: randInt(5,20)
      });
    }

    waves.push(customers);
  }

  return waves;
}


function renderCastList(){
  const el = document.getElementById("castList");
  el.innerHTML = GameState.casts.map(c=>{
    const cond = computeCondition(c);
    return `
      <div class="row" style="margin:6px 0;">
        <img class="avatar" src="${c.img}" alt="${c.name}">
        <div style="flex:1;">
          <div><strong>${c.name}</strong> Lv${c.lv} <span class="pill">${c.look}/${c.nature}</span></div>
          <div>æ„›æƒ³:${c.aisou} ä¼šè©±:${c.kaiwa} æ°—é£ã„:${c.attentiveness} ï¼ çµ¦æ–™:${yen(c.salary)}</div>
          <div>ç–²åŠ´:${c.fati}/${c.fatiMax} ã‚¹ãƒˆãƒ¬ã‚¹:${c.stress}/${c.stressMax} <span class="pill">${cond}</span></div>
        </div>
      </div>
    `;
  }).join("");
}

function fillTrainTarget(){
  const sel = document.getElementById("trainTarget");
  sel.innerHTML = GameState.casts.map(c=>`<option value="${c.id}">${c.name}</option>`).join("");
}

function showPhase(name){
  const phases = ["day","night","result"];
  phases.forEach(p=>{
    document.getElementById("phase"+p.charAt(0).toUpperCase()+p.slice(1)).style.display = (p===name) ? "block" : "none";
  });
}


/* ===========
   ã‚·ãƒ•ãƒˆ
   =========== */
function rollShiftRandom(){
  // ä¸€æ—¦å…¨å“¡ä¼‘ã¿ã«ã™ã‚‹
  GameState.casts.forEach(c => GameState.shifts[c.id] = false);

  // ç¬¬1é€±ã¯å…¨å“¡å‡ºå‹¤
  if(GameState.week === 1){
    GameState.casts.forEach(c => {
      GameState.shifts[c.id] = true;
    });
    renderShiftList();
    return;
  }

  // é€”ä¸­åŠ å…¥ã‚­ãƒ£ãƒ©ã¯åŠ å…¥é€±ã¯å¿…ãšå‡ºå‹¤
  const mustWork = GameState.casts.filter(c => c.joinWeek === GameState.week);
  mustWork.forEach(c => {
    GameState.shifts[c.id] = true;
  });

  // ãƒ©ãƒ³ãƒ€ãƒ ã§æ®‹ã‚Šã‚’é¸å‡ºï¼ˆæœ€ä½1äººã¯å‡ºå‹¤ï¼‰
  const activeCount = Math.max(1, Math.floor(GameState.casts.length * 0.6));
  const shuffled = [...GameState.casts].sort(() => Math.random() - 0.5);

  let count = 0;
  for(let i=0; i<shuffled.length && count<activeCount; i++){
    const c = shuffled[i];
    if(!GameState.shifts[c.id]){ // ã¾ã ä¼‘ã¿ãªã‚‰å‡ºå‹¤ã«ã™ã‚‹
      GameState.shifts[c.id] = true;
      count++;
    }
  }

  renderShiftList();
}

function renderShiftList(){
  const el = document.getElementById("shiftList");
  el.innerHTML = GameState.casts.map(c=>{
    const on = GameState.shifts[c.id] === true;
    return `
      <div class="row" style="margin:6px 0;">
        <img class="avatar" src="${c.img}">
        <div style="flex:1;">
          <strong>${c.name}</strong> <span class="pill">${on?'å‡ºå‹¤':'ä¼‘ã¿'}</span>
        </div>
        <button class="btn" onclick="toggleShift('${c.id}')"
                style="position: relative; /* relativeã‚’æŒ‡å®š */
                right: 10px;" /* å·¦ã‹ã‚‰20pxç§»å‹• */
                >${on?'ä¼‘ã¿ã«ã™ã‚‹':'å‡ºå‹¤ã«ã™ã‚‹'}</button>
      </div>
    `;
  }).join("");
}
function toggleShift(id){
const cast = GameState.casts.find(c => c.id === id);
  const wasOn = GameState.shifts[id] === true; // åˆ‡ã‚Šæ›¿ãˆå‰ã®çŠ¶æ…‹
  const nowOn = !wasOn;                        // åˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹
  GameState.shifts[id] = nowOn;

  // ã‚¹ãƒˆãƒ¬ã‚¹å€¤ã®åæ˜ 
  if(cast){
    if(!wasOn && nowOn){
      // åˆæœŸçŠ¶æ…‹ãŒä¼‘ã¿ â†’ å‡ºå‹¤ã«å¤‰æ›´ã—ãŸã¨ãã ã‘ã‚¹ãƒˆãƒ¬ã‚¹å¢—åŠ 
      cast.stress = Math.min(cast.stressMax, cast.stress + 50);
    }
    // ä¼‘ã¿ã«å¤‰æ›´ã—ãŸã¨ãã¯ã‚¹ãƒˆãƒ¬ã‚¹æ¸›å°‘ã•ã›ãŸã„ãªã‚‰ã“ã“ã«å‡¦ç†ã‚’æ›¸ã
     else if(wasOn && !nowOn){
       cast.stress = Math.max(0, cast.stress - 10);
     }
  }

  // UIã‚’å†æç”»
  renderShiftList();
}
/* ===========
   åºƒå‘Š
   =========== */
const AdDefs = {
  none:{ cost:0, effect:0, popUp:0 },
  sns:{ cost:5000, effect:0.05, popUp:0 },
  event:{ cost:15000, effect:0.15, popUp:2 },
  mag:{ cost:30000, effect:0.30, popUp:5 }
};
document.getElementById("adSelect").addEventListener("change", e=>{
  const key = e.target.value;
  GameState.ad = key;
  GameState.adCost = AdDefs[key].cost;
  GameState.adEffect = AdDefs[key].effect;
});

/* ===========
   æ•™è‚²
   =========== */
document.getElementById("btnTrain").addEventListener("click", ()=>{
  const id = document.getElementById("trainTarget").value;
  const stat = document.getElementById("trainStat").value;
  const budget = parseInt(document.getElementById("trainBudget").value||"0",10);
  const c = GameState.casts.find(x=>x.id===id);
  if(!c) return;
  if(GameState.funds < budget){ alert("è³‡é‡‘ä¸è¶³ã§ã™"); return; }

  // æ•™è‚²åŠ¹æœï¼šäºˆç®—ã«å¿œã˜ã¦ 1ã€œ(budget/2000+2) ãƒ©ãƒ³ãƒ€ãƒ ä¸Šæ˜‡
  const inc = randInt(1, Math.max(2, Math.floor(budget/2000)+2));
  c[stat] = c[stat] + inc;
  c.fati = clamp(c.fati + 10, 0, c.fatiMax);
  GameState.funds -= budget;

  renderHeader();
  renderCastList();
  alert(`${c.name}ã®${stat}ãŒ+${inc}ã•ã‚Œã¾ã—ãŸï¼ˆè²»ç”¨:${yen(budget)}ï¼ç–²åŠ´+10ï¼‰`);
});

/* ===========
   æ¡ç”¨
   =========== */
document.getElementById("btnGenCandidates").addEventListener("click", ()=>{
  const budget = parseInt(document.getElementById("hireBudget").value||"0",10);
  if(GameState.funds < budget){ alert("è³‡é‡‘ä¸è¶³ã§ã™"); return; }

  const rankFactor = RankSteps.indexOf(GameState.rank) + 1; // ä¸Šä½ã»ã©åˆæœŸå€¤â†‘
  const count = clamp(randInt(1,6) + Math.floor(rankFactor/2), 1, 6);
  const looks = ["ã‚­ãƒ¥ãƒ¼ãƒˆ","ã‚¯ãƒ¼ãƒ«","ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼","ã‚»ã‚¯ã‚·ãƒ¼","ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«"];
  const natures = ["æ˜ã‚‹ã„","å¤§äººã—ã„","å…ƒæ°—","ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹","ç©ã‚„ã‹"];
  const base = Math.min(80, 45 + rankFactor*5);
  const swing = 20 + Math.floor(budget/10000)*3;

// æ¼¢å­—ç³»ï¼ˆç‹é“ãƒ»æ¸…æ¥šãƒ»æ—¥æœ¬çš„ï¼‰: 70å€‹
const kanjiNames = [
  "ç¾å’²","å½©èŠ±","ç²å¥ˆ","çœŸå¤®","é¦™ç¹”","èˆ","è¯","æ„›è‰","çµè¡£","æ²™ç¾…",
  "é¥","è©©ç¹”","è‰å­","èœã€…ç¾","æ˜æ—¥é¦™","èŒ","ä½³å¥ˆ","ç©‚ä¹ƒé¦™","æ","å‡›",
  "è‘µ","ç´éŸ³","ç‘ ç’ƒ","æ¥“","é™½èœ","çµèœ","å’²å¸Œ","ç¾æ³¢","ç´¬","å¿ƒæ˜¥",
  "æ¡ƒèŠ±","ç‘å¸Œ","è˜­","èŒœ","ç´—å­£","æ™ºå­","æµ","ç¾ç·’","å¤å¸Œ","æ¢¨ä¹ƒ",
  "åƒå°‹","æ¶¼èŠ±","èŠ½ä¾","å®Ÿçµ","å‹æ¢¨","äºœç¾","é™½è‘µ","æ¾ª","æå¥ˆ","è©©å¥ˆ",
  "çœŸå„ª","å½©å¸Œ","ç¾è²´","ç”±ä½³","å¥ˆæ´¥ç¾","æœ±é‡Œ","æ¡ƒå­","é¦™æ¾„","åƒå¤","ç¶¾ä¹ƒ",
  "æ¢¨ã€…èŠ±","èŠ½ç”Ÿ","å¸Œç¾","å½©éŸ³","è‰å¤®","å¸†ä¹ƒèŠ±","å’²è‰¯","èˆè¡£","çœŸå‡œ","æ˜¥é¦™"
];

// ã²ã‚‰ãŒãªç³»ï¼ˆæŸ”ã‚‰ã‹ã„ãƒ»å¯æ„›ã„ãƒ»è¦ªã—ã¿ã‚„ã™ã„ï¼‰: 70å€‹
const hiraganaNames = [
  "ã‚ã‹ã‚Š","ã‚†ãšã¯","ã¿ãŠ","ã•ãã‚‰","ãªãªã¿","ã¯ã‚‹ã‹","ã‚‚ã‚‚","ã¡ã‹","ã²ãª","ã®ãã¿",
  "ã™ã¿ã‚Œ","ã“ã“ã‚","ã¤ã‚€ã","ã²ã‚ˆã‚Š","ãã‚‹ã¿","ã¾ã‚Šã‚“","ã‚ã„","ã‚ã„ã‚Š","ã¾ãŠ","ã‚ŠãŠ",
  "ã‹ã®ã‚“","ãµã†ã‹","ã‚†ã‚","ã•ãª","ã“ã¯ã‚‹","ã„ã‚ã¯","ã¿ãªã¿","ã¿ã¤ã","ã¾ãª","ã—ãŠã‚Š",
  "ã‚ãŠã„","ã‚†ã„","ã¿ã","ã¯ãª","ã‚Œãª","ã¨ã‚‚ã‹","ã²ãªãŸ","ã†ãŸ","ã‚ã„","ã‚Šã‚Š",
  "ã™ãš","ã¡ã²ã‚","ã‚ã‹ãª","ã¤ã¼ã¿","ã“ãªã¤","ã¿ãª","ã¾ã²ã‚","ã‚ã‚„","ã‚†ã","ã‚ã‚„ã‹",
  "ã‚Šã®","ã¿ã•ã","ã¾ã‚Š","ã‹ãª","ã‚Šã•","ã»ã®ã‹","ãªãª","ã¾ã‚†","ã‚ã™ã‹","ã¿ã‚†",
  "ãˆã¾","ã‚Šã‹","ã‚ãã¿","ã¿ã‹","ã•ã‚„","ã¡ãˆ","ã¿ãªã“","ãˆã‚Š","ã‹ã»","ã•ã"
];

// ã‚«ã‚¿ã‚«ãƒŠç³»ï¼ˆæºæ°åãƒ»ãƒãƒ¼ãƒ•é¢¨ãƒ»è¯ã‚„ã‹ï¼‰: 70å€‹
const katakanaNames = [
  "ãƒãƒªã‚¢","ã‚¨ãƒªã‚«","ãƒªãƒŠ","ã‚¢ã‚¤","ãƒŠãƒ„","ã‚«ãƒ¬ãƒ³","ãƒ¦ã‚¤","ãƒŸãƒŠ","ã‚¢ã‚ªã‚¤","ãƒ¬ã‚¤ãƒŠ",
  "ã‚¢ãƒ³ãƒŠ","ã‚µãƒ©","ãƒŸã‚«","ã‚¸ãƒ¥ãƒª","ãƒ«ãƒŠ","ã‚»ãƒŠ","ãƒ¢ãƒŠ","ãƒã‚¢","ãƒ™ãƒ‹","ãƒŸã‚¨ãƒ«",
  "ãƒ†ã‚£ã‚¢","ãƒã‚¨ãƒ«","ã‚¢ãƒªã‚¹","ã‚¨ãƒ","ãƒ‹ãƒ¼ãƒŠ","ãƒ‡ã‚£ã‚¢ãƒŠ","ãƒ“ã‚¢ãƒ³ã‚«","ãƒ¡ãƒ­ãƒ‡ã‚£","ã‚·ãƒ£ãƒ­ãƒ³","ã‚¢ãƒ³ã‚¸ãƒ¥",
  "ãƒ«ãƒ«","ãƒ©ãƒ©","ãƒŠãƒŠ","ã‚­ãƒ©ãƒ©","ãƒŸãƒ«ã‚¯","ã‚·ãƒ§ã‚³ãƒ©","ãƒ¢ãƒ¢ã‚«","ãƒ’ã‚«ãƒ«","ãƒŸã‚µ","ãƒªã‚µ",
  "ã‚»ã‚·ãƒ«","ãƒªãƒªã‚£","ãƒ­ãƒ¼ã‚º","ã‚¸ãƒ£ã‚¹ãƒŸãƒ³","ã‚µãƒ•ã‚¡ã‚¤ã‚¢","ãƒ«ãƒ“ãƒ¼","ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰","ãƒãƒªãƒ³","ãƒ«ãƒ","ã‚¹ãƒ†ãƒ©",
  "ã‚·ã‚ªãƒ³","ã‚«ãƒãƒ³","ãƒŸãƒ¥ã‚¦","ãƒãƒ­ãƒ«","ãƒ“ã‚¹ã‚³","ãƒãƒ§ã‚³","ãƒãƒ‹ãƒ©","ã‚¹ãƒ•ãƒ¬","ãƒ—ãƒªãƒ³","ãƒ™ãƒ«",
  "ã‚·ãƒ£ãƒ«ãƒ­ãƒƒãƒˆ","ãƒ•ãƒ­ãƒ¼ãƒ©","ãƒ´ã‚£ãƒ´ã‚£ã‚¢ãƒ³","ã‚¯ãƒ­ã‚¨","ã‚ªãƒªãƒ“ã‚¢","ã‚½ãƒ•ã‚£ã‚¢","ãƒŸãƒ©","ãƒŠã‚¿ãƒªãƒ¼","ã‚¯ãƒ©ãƒ©","ã‚¸ãƒ¥ã‚¨ãƒ«"
];
function randomGenjiName(){
  const type = randInt(1,3); // 1=æ¼¢å­—, 2=ã²ã‚‰ãŒãª, 3=ã‚«ã‚¿ã‚«ãƒŠ
  if(type === 1){
    return pick(kanjiNames);
  } else if(type === 2){
    return pick(hiraganaNames);
  } else {
    return pick(katakanaNames);
  }
}


const lookImgMap = {
  "ã‚­ãƒ¥ãƒ¼ãƒˆ": Array.from({ length: 30 }, (_, i) => `images/character/cute/cute (${i + 1}).jpg`),
  "ã‚¯ãƒ¼ãƒ«": Array.from({ length: 30 }, (_, i) => `images/character/cool/cool (${i + 1}).jpg`),
  "ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼": Array.from({ length: 30 }, (_, i) => `images/character/beauty/beauty (${i + 1}).jpg`),
  "ã‚»ã‚¯ã‚·ãƒ¼": Array.from({ length: 30 }, (_, i) => `images/character/sexy/sexy (${i + 1}).jpg`),
  "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«": Array.from({ length: 30 }, (_, i) => `images/character/casual/casual (${i + 1}).jpg`)
};

  let html = ""; // ã“ã‚ŒãŒãªã„ã¨ html += ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™

  for(let i=0; i<count; i++){
    const look = pick(looks); // å¤–è¦‹ã‚¿ã‚¤ãƒ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
    const imgList = lookImgMap[look] || [];
    const img = imgList.length ? pick(imgList) : "img/placeholder.jpg"; // å®‰å…¨ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

    const cand = {
      id: "cand_"+Date.now()+"_"+i,
      name:randomGenjiName(),
      img: img,
      look: look, // â† ä¿®æ­£ï¼šé…åˆ— looks ã§ã¯ãªãå˜ä½“ã® look
      nature: pick(natures),
      aisou: clamp(randInt(base-swing, base+swing), 35, 95),
      kaiwa: clamp(randInt(base-swing, base+swing), 35, 95),
      attentiveness: clamp(randInt(base-swing, base+swing), 35, 95),
      fati: 0, fatiMax: 100,
      stress: 0, stressMax: 100,
      cond: "æ™®é€š",
      lv: 1, exp: 0,
      salary: clamp(9000 + randInt(-1500, 1500), 7000, 14000),
      isInitial: false,
      joinWeek: GameState.week
    };

html += `
  <div class="row" style="margin:6px 0;" data-id="${cand.id}">
    <img class="avatar" src="${cand.img}">
    <div style="flex:1;">
      <strong>${cand.name}</strong> <span class="pill">${cand.look}/${cand.nature}</span>
      <div>AI:${cand.aisou} TK:${cand.kaiwa} CA:${cand.attentiveness} ï¼ çµ¦æ–™:${yen(cand.salary)}</div>
    </div>
    <button class="btn" onclick='hire(${JSON.stringify(cand)})'>æ¡ç”¨ã™ã‚‹</button>
  </div>
`;
  }

  document.getElementById("hireCandidates").innerHTML = html;

  // ç”Ÿæˆæ™‚ã«è²»ç”¨æ¶ˆè²»ï¼ˆä»•æ§˜ã©ãŠã‚Šãªã‚‰ã“ã“ã§æ¶ˆè²»ï¼‰
  GameState.funds -= budget;
  renderHeader();
});

function hire(cand){
  // ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã«è¿½åŠ 
  GameState.casts.push(cand);
  alert(`${cand.name}ã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼`);

  // ã‚·ãƒ•ãƒˆãƒ»ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§ã‚’æ›´æ–°
  renderShiftList();
  renderCastList();
  rollShiftRandom();

  // å€™è£œãƒªã‚¹ãƒˆã‹ã‚‰ã“ã®äººã ã‘å‰Šé™¤
  const area = document.getElementById("hireCandidates");
  const candEl = area.querySelector(`[data-id="${cand.id}"]`);
  if(candEl) candEl.remove();
}

/* ===========
   ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³è£œæ­£
   =========== */
function computeCondition(c){
  const ratio = c.fati / c.fatiMax;
  if(ratio < 0.3) return "è‰¯å¥½";
  if(ratio < 0.6) return "æ™®é€š";
  if(ratio < 0.9) return "ç–²åŠ´";
  return "çµ¶ä¸èª¿";
}
function conditionStatMod(c){
  const cond = computeCondition(c);
  if(cond==="è‰¯å¥½") return 1.05;
  if(cond==="æ™®é€š") return 1.0;
  if(cond==="ç–²åŠ´") return 0.9;
  return 0.8; // çµ¶ä¸èª¿
}

/* ===========
   å¤œãƒ•ã‚§ãƒ¼ã‚ºæº–å‚™ï¼ˆæ¥å®¢æ³¢ç”Ÿæˆï¼‰
   =========== */
document.getElementById("btnStartNight").addEventListener("click", startNight);
// startNighté–¢æ•°ã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³
function startNight(){
    // 1. ãƒ©ãƒ³ã‚¯ã«åŸºã¥ã„ã¦åŸºæœ¬ã®ã‚¦ã‚§ãƒ¼ãƒ–æ•°ã‚’æ±ºå®š
    let baseWaveCount = 3; 

    const rank = GameState.rank;
    if (rank === "æ ¼å®‰") {
        baseWaveCount = 2; // æ ¼å®‰ãªã‚‰åŸºæœ¬2æ³¢
    } else if (rank === "å¤§è¡†") {
        baseWaveCount = 3; // å¤§è¡†ãƒ»ä¸­ç´šã¯åŸºæœ¬3æ³¢
    } else if (rank === "é«˜ç´š") {
        baseWaveCount = 4; // é«˜ç´šãªã‚‰åŸºæœ¬4æ³¢
    } else if (rank === "ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸" || rank === "V.I.P.") {
        baseWaveCount = 5; // æœ€é«˜ãƒ©ãƒ³ã‚¯ã¯åŸºæœ¬5æ³¢
    }

    // 2. åŸºæœ¬å€¤ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå¤‰å‹•ï¼ˆä¾‹: -1, 0, +1ï¼‰ã‚’åŠ ãˆã‚‹
    // randInt(-1, 1) ã¯ -1, 0, 1 ã®ã„ãšã‚Œã‹ã‚’è¿”ã™
    const randomAdjustment = randInt(-1, 1); 

    // 3. æœ€çµ‚çš„ãªã‚¦ã‚§ãƒ¼ãƒ–æ•°ã‚’è¨ˆç®—ã—ã€æœ€å°2ã€æœ€å¤§6ã«åˆ¶é™ã™ã‚‹
    // (æœ€å¤§å€¤ã¯ã‚²ãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦6ã‚’è¨­å®š)
    const minWaves = 2;
    const maxWaves = 6;
    const finalWaveCount = clamp(baseWaveCount + randomAdjustment, minWaves, maxWaves);

    // ä»¥å‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰Šé™¤ã—ã€æ–°ã—ã„ finalWaveCount ã‚’ä½¿ç”¨
    const waveCount = finalWaveCount; // ä¾‹: æ ¼å®‰ãªã‚‰ 1ã€œ3

    GameState.waves = [];
    for(let i=0;i<waveCount;i++){
        // åŒæ™‚æ¥å®¢æ•°ï¼š1ã€œ7ã€ãƒ©ãƒ³ã‚¯ãŒé«˜ã„ã»ã©å¤šã‚
        // ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»¥å‰ã® startNight ã‹ã‚‰å¤‰æ›´ãªã—
        const simBase = randInt(1,7);
        const sim = clamp(simBase + Math.floor(RankSteps.indexOf(GameState.rank)/3), 1, 7);
        GameState.waves.push(generateCustomers(sim));
    }
    
    GameState.waveCursor = 0;
    GameState.assignments = {};

    openWaveModal();
}

// æ³¨æ„: generateCustomers() ã¯ã“ã®ã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€
// startNight() ãŒä¾å­˜ã—ã¦ã„ã‚‹å¤–éƒ¨é–¢æ•°ã§ã™ã€‚
function generateCustomers(count){
  const types = ["åˆå¿ƒè€…","ä¸€èˆ¬","å¸¸é€£","ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒ‰","VIP"];
  const typeWeights = [4, 6, 4, 2, 1 + Math.floor(RankSteps.indexOf(GameState.rank)/2)];
  const nature = ["é™ã‹","é™½æ°—","çµ¡ã¿å„ä»‹"];
  const looks = ["ã‚­ãƒ¥ãƒ¼ãƒˆ","ã‚¯ãƒ¼ãƒ«","ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼","ã‚»ã‚¯ã‚·ãƒ¼","ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«"];
  const stats = ["æ„›æƒ³","ä¼šè©±","æ°—é£ã„"];

  function weightedPick(arr, weights){
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for(let i=0;i<arr.length;i++){
      r -= weights[i];
      if(r<=0) return arr[i];
    }
    return arr[arr.length-1];
  }

  const customers = [];
  for(let i=0;i<count;i++){
    const t = weightedPick(types, typeWeights);
    const basePrice = { "åˆå¿ƒè€…": 2000, "ä¸€èˆ¬": 3000, "å¸¸é€£": 4000, "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒ‰": 5500, "VIP": 8000 }[t];
    const reqStat = pick(stats);
    // ãƒ©ãƒ³ã‚¯é«˜ã„ã»ã©è¦æ±‚â†‘
    const reqBase = 45 + RankSteps.indexOf(GameState.rank)*6;
    const reqVal = clamp(randInt(reqBase-5, reqBase+15), 30, 95);
    const n = pick(nature);
    const like = { look: pick(looks), nature: pick(nature) };
    const troubleRate = clamp(randInt(10,50) - Math.floor(avgAttentiveness()/10), 5, 50); // CAé«˜ã„ã¨ä½ä¸‹
    customers.push({
      type:t, nature:n, like, basePrice, reqStat, reqVal,
      troubleRate
    });
  }
  return customers;
}
function avgAttentiveness(){
  const onCast = GameState.casts.filter(c=>GameState.shifts[c.id]);
  if(onCast.length===0) return 50;
  return Math.floor(onCast.reduce((s,c)=>s+c.attentiveness,0)/onCast.length);
}

/* ===========
   æ³¢ãƒ¢ãƒ¼ãƒ€ãƒ«
   =========== */
function openWaveModal(){
  const idx = GameState.waveCursor;
  const waves = GameState.waves;
  const wave = waves[idx];
  GameState.weekSales = 0;

  if(!wave){ closeWaveModal(); finishNight(); return; }

  // ã‚¿ã‚°æ›´æ–°
  document.getElementById("waveIndex").textContent = idx+1;
  document.getElementById("waveTotal").textContent = waves.length;
  document.getElementById("waveRankTag").textContent = GameState.rank;

  // å®¢ä¸€è¦§
const custHtml = wave.map((c, i)=>{
  const onCast = GameState.casts.filter(ca=>GameState.shifts[ca.id]);
  const options = onCast.map(ca=>`<option value="${ca.id}">${ca.name}</option>`).join("");

  return `
  <div class="subpanel">
    <div class="row">
      <span class="tag ${c.type==='VIP'?'vip':''}">${c.type}</span>
      <span class="pill">${c.nature}</span>
    </div>
    <div>è¦æ±‚: ${c.reqStat.toUpperCase()} â‰¥ ${c.reqVal} ï¼ å¥½ã¿: ${c.like.look}/${c.like.nature} ï¼ åŸºæº–é¡: ${yen(c.basePrice)}</div>
    <div>ãƒˆãƒ©ãƒ–ãƒ«ç‡: ${c.troubleRate}%</div>
    <div class="row" style="margin-top:6px;">
      <select class="input" id="assign_${idx}_${i}">
        <option value="">æœªé…ç½®</option>
        ${options}
      </select>
      <button class="btn" onclick="assignCastToCustomer(${idx},${i})">é…ç½®</button>
    </div>
    <div id="assigned_${idx}_${i}" class="row" style="margin-top:6px;">
      <span class="muted">æœªé…ç½®</span>
    </div>
  </div>`;
}).join("");  document.getElementById("waveCustomers").innerHTML = custHtml;

  // å‡ºå‹¤ã‚­ãƒ£ã‚¹ãƒˆã‹ã‚‰é…ç½®UI
  const onCast = GameState.casts.filter(c=>GameState.shifts[c.id]);
  const assignHtml = onCast.map(c=>`
    <div class="row" style="margin:6px 0;">
      <img class="avatar" src="${c.img}">
      <div style="flex:1;">
        <strong>${c.name}</strong>ï¼ˆæ„›æƒ³:${c.aisou} ä¼šè©±:${c.kaiwa} æ°—é£ã„:${c.attentiveness}ï¼‰
      </div>
      </select>
  `).join("");
  document.getElementById("assignArea").innerHTML = assignHtml;

  document.getElementById("waveModal").style.display = "flex";
}
function closeWaveModal(){ document.getElementById("waveModal").style.display = "none"; }

function assignCastToCustomer(waveIndex, customerIndex){
  const sel = document.getElementById(`assign_${waveIndex}_${customerIndex}`);
  const castId = sel.value;
  if(!castId) return;

  GameState.assignments[waveIndex] = GameState.assignments[waveIndex] || {};
  GameState.assignments[waveIndex][customerIndex] = castId;

  const cast = GameState.casts.find(c=>c.id===castId);

  const fatiPercent = Math.floor((cast.fati / cast.fatiMax) * 100);
  const stressPercent = Math.floor((cast.stress / cast.stressMax) * 100);

  document.getElementById(`assigned_${waveIndex}_${customerIndex}`).innerHTML = `
    <div class="row" style="align-items:center; gap:8px;">
      <img src="${cast.img}" class="avatar" style="width:30px;height:30px;">
      <div>
        <div><strong>${cast.name}</strong></div>
        <div style="font-size:12px; color:#666;">ç–²åŠ´: ${fatiPercent}% ï¼ ã‚¹ãƒˆãƒ¬ã‚¹: ${stressPercent}%</div>
        <div style="width:100px; background:#eee; border-radius:6px; overflow:hidden; margin:2px 0;">
          <div style="width:${fatiPercent}%; background:#ff69b4; height:6px;"></div>
        </div>
        <div style="width:100px; background:#eee; border-radius:6px; overflow:hidden;">
          <div style="width:${stressPercent}%; background:#87cefa; height:6px;"></div>
        </div>
      </div>
    </div>
  `;
}


document.getElementById("btnResolveWave").addEventListener("click", ()=>{
  resolveWave(false);
});
document.getElementById("btnSkipAssign").addEventListener("click", ()=>{
  resolveWave(true);
});

function resolveWave(skipped){
  const idx = GameState.waveCursor;
  const wave = GameState.waves[idx];
  const assigns = GameState.assignments[idx] || {};
  let salesThisWave = 0;
  let repDelta = 0;

  // è©•ä¾¡ã¨å£²ä¸Š
  wave.forEach((cust, ci)=>{
    const castId = assigns[ci];
    if(castId == null){
      // æœªé…ç½®ã®ç¢ºèªãƒ­ã‚°ç›¸å½“ï¼ˆUIã§ã¯æ§ãˆã‚ã«ãƒšãƒŠãƒ«ãƒ†ã‚£ã«åæ˜ ï¼‰
      repDelta -= 1;
      return;
    }
    const cast = GameState.casts.find(c=>c.id===castId);
    if(!cast) return;

    // ç–²åŠ´MAXè¶…ãˆã§å¯¾å¿œã•ã›ã‚‹ã¨ã‚¹ãƒˆãƒ¬ã‚¹+10
    if(cast.fati >= cast.fatiMax){
      cast.stress = clamp(cast.stress + 10, 0, cast.stressMax);
    }

    // ç›¸æ€§è£œæ­£
    const likeBonus = (cast.look===cust.like.look ? 1.15 : 1.0) *
                      (cast.nature===cust.like.nature ? 1.10 : 1.0);

    // ã‚¹ãƒ†è¦æ±‚åˆ¤å®š
    const statVal = cust.reqStat==="æ„›æƒ³" ? cast.aisou :
                    cust.reqStat==="ä¼šè©±" ? cast.kaiwa : cast.attentiveness;
    const meets = statVal >= cust.reqVal;
    repDelta += meets ? 1 : -1;

    // ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³è£œæ­£
    const mod = conditionStatMod(cast);

    // ä¾¡æ ¼ãƒ»å£²ä¸Šè¨ˆç®—
    let price = cust.basePrice;
    price *= (meets ? 1.15 : 0.85);
    price *= likeBonus;
    price *= mod;
    price *= (1 + GameState.adEffect); // åºƒå‘ŠåŠ¹æœã¯éœ€è¦å¢—ã¨ã¿ãªã—ã¦å˜ä¾¡ã«ã‚‚å°‘ã—ä¹—ã›ã‚‹ç°¡ç•¥åŒ–

    if(castId){
      const castSales = GameState.perCastSales.find(x => x.id === castId);
      if(castSales) castSales.sales += price;
}

    salesThisWave += price;
ã€€ã€€GameState.weekSales += price;

    // ç–²åŠ´å¢—æ¸›ï¼ˆæ¥å®¢ã§ï¼‹10ï¼‰
    cast.fati = clamp(cast.fati + 10, 0, cast.fatiMax + 30); // ã‚ªãƒ¼ãƒãƒ¼ã•ã›ã‚‹ä½™åœ°ï¼ˆMAXè¶…ã§çµ¶ä¸èª¿ï¼‰
  });

  // æœªé…ç½®å®¢ãŒã„ãŸå ´åˆã‚„ã‚¹ã‚­ãƒƒãƒ—æ™‚ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ãƒ»éæ¥å®¢è€…ã®ç–²åŠ´æ¸›å°‘
  const onCast = GameState.casts.filter(c=>GameState.shifts[c.id]);
  onCast.forEach(c=>{
    const handled = Object.values(assigns).includes(c.id);
    if(!handled){
      // éæ¥å®¢ã§ç–²åŠ´-5
      c.fati = clamp(c.fati - 5, 0, c.fatiMax);
    }
  });

  GameState.totalSales += salesThisWave;
  GameState.funds += salesThisWave; // å£²ä¸ŠåŠ ç®—
  GameState.rep = clamp(GameState.rep + repDelta, 0, 100);

  // ãƒˆãƒ©ãƒ–ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®šï¼ˆæ¥å®¢æ³¢ã”ã¨ã«1å›ï¼‰
  const troubleChance = Math.min(0.25, 0.05 + (wave.length * 0.01)); // æ··é›‘ã»ã©å°‘ã—ä¸ŠãŒã‚‹
  if(Math.random() < troubleChance){
    openTrouble(wave, assigns);
    // ãƒˆãƒ©ãƒ–ãƒ«ã‚’å‡¦ç†ã—ã¦ã‹ã‚‰æ³¢ã‚’é€²ã‚ã‚‹
    return;
  }

  // æ¬¡ã®æ³¢ã¸
  GameState.waveCursor++;
  renderHeader();
  if(GameState.waveCursor >= GameState.waves.length){
    closeWaveModal();
    finishNight();
  } else {
    openWaveModal();
  }
}

/* ===========
   ãƒˆãƒ©ãƒ–ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
   =========== */
function openTrouble(wave, assigns){
  // --- è¿½åŠ ï¼šãƒ•ãƒ©ã‚°ã®ãƒªã‚»ãƒƒãƒˆ ---
  GameState.troubleResolved = false; 

  // --- è¿½åŠ ï¼šãƒœã‚¿ãƒ³ã®å†æœ‰åŠ¹åŒ– ---
  document.querySelectorAll("#troubleModal button[data-choice]").forEach(btn => {
    btn.disabled = false;
  });

  const candidates = Object.entries(assigns).map(([ci, castId])=>{
    const c = GameState.casts.find(x=>x.id===castId);
    return c;
  }).filter(Boolean);
  
  // ã‚­ãƒ£ã‚¹ãƒˆã®é¸å®š
  const actor = candidates.length ? pick(candidates) : pick(GameState.casts.filter(c=>GameState.shifts[c.id]));

  // ã‚¿ã‚¤ãƒ—é¸å®š
  const types = [
    {key:"bad_claim", title:"æ‚ªè³ªã‚¯ãƒ¬ãƒ¼ãƒãƒ¼", text:"å¼·æ°—ãªæ…‹åº¦ã§å‡ºç¦å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"},
    {key:"drunk", title:"é…”ã£ã±ã‚‰ã„çµ¡ã¿", text:"è½ã¡ç€ã„ã¦é€€åº—ã—ã¦ã‚‚ã‚‰ã†ã®ãŒé©åˆ‡ã§ã™ã€‚"},
    {key:"annoy", title:"çµ¡ã¿å„ä»‹å®¢", text:"æ³¨æ„å¯¾å¿œã§å ´ã‚’æ•´ãˆã¾ã—ã‚‡ã†ã€‚"}
  ];
  const t = pick(types);

  // UIåæ˜ 
  document.getElementById("troubleBody").innerHTML = `
    <div class="row">
      <img class="avatar" src="${actor.img}">
      <div>
        <div><strong>${actor.name}</strong> ãŒå¯¾å¿œã—ã¾ã™</div>
        <div>${t.title}ï¼š${t.text}</div>
      </div>
    </div>
  `;
  document.getElementById("troubleResult").innerHTML = "";
  document.getElementById("troubleModal").style.display = "flex";

  // é¸æŠè‚¢ãƒãƒ³ãƒ‰ãƒ©ï¼ˆé–¢æ•°å†…ã«å®šç¾©ã—ã¦ actor ã‚’ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§åˆ©ç”¨ï¼‰
  function handle(choice){
    if(GameState.troubleResolved) return;
    GameState.troubleResolved = true;

    const key = choice==="strong" ? "kaiwa" :
                choice==="calm" ? "aisou" : "attentiveness";
    const base = 0.4 + (actor[key]/200); 
    const ok = Math.random() < base;

    if(ok){
      GameState.rep = clamp(GameState.rep + 2, 0, 100);
      actor.exp += 40;
      document.getElementById("troubleResult").innerHTML =
        `<span class="ok">æˆåŠŸï¼ è©•åˆ¤+2 / EXP+40</span>`;
    }else{
      GameState.funds -= 2000;
      actor.stress = clamp(actor.stress + 10, 0, actor.stressMax);
      let resText = `<span class="bad">å¤±æ•—â€¦ å£²ä¸Šæå¤±Â¥2,000 / ${actor.name} ã‚¹ãƒˆãƒ¬ã‚¹+10</span>`;
      
      if(!actor.isInitial && Math.random() < 0.05){
        GameState.casts = GameState.casts.filter(c=>c.id!==actor.id);
        resText += `<div class="bad">çªç„¶ã®è¾è·ãŒç™ºç”Ÿâ€¦ ${actor.name}ãŒé€€è·ã—ã¾ã—ãŸ</div>`;
      }
      document.getElementById("troubleResult").innerHTML = resText;
    }

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    document.querySelectorAll("#troubleModal button[data-choice]").forEach(btn=>{
      btn.disabled = true;
    });

    renderHeader();
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šï¼ˆæ¯å›ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§æœ€æ–°ã® actor ã‚’å‚ç…§ã•ã›ã‚‹ï¼‰
  document.getElementById("troubleStrong").onclick = ()=>handle("strong");
  document.getElementById("troubleCalm").onclick  = ()=>handle("calm");
  document.getElementById("troubleWarn").onclick  = ()=>handle("warn");

  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  document.getElementById("btnCloseTrouble").onclick = ()=>{
    document.getElementById("troubleModal").style.display = "none";
    
    // æ¬¡ã®æ³¢ã¸é€²ã‚€
    GameState.waveCursor++;
    if(GameState.waveCursor >= GameState.waves.length){
      // waveModalè‡ªä½“ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹å‡¦ç†ãŒå¿…è¦
      if(typeof closeWaveModal === "function") closeWaveModal();
      finishNight();
    } else {
      // openWaveModalãŒã€Œæ¬¡ã®æ³¢ã®æº–å‚™ã€ã‚’ã™ã‚‹å‰æ
      openWaveModal();
    }
  };
}/* ===========
   å¤œãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº† â†’ çµæœãƒ•ã‚§ãƒ¼ã‚º
   =========== */
function finishNight(){
  // --- å‰åŠï¼šçµ¦æ–™ãƒ»åºƒå‘Šãƒ»å£²ä¸Šé›†è¨ˆ ---
  const salary = GameState.casts.filter(c => GameState.shifts[c.id])
    .reduce((s, c) => s + c.salary, 0);
  GameState.funds -= salary;
  GameState.funds -= GameState.adCost;
  GameState.pop = clamp(GameState.pop + AdDefs[GameState.ad].popUp, 0, 100);

  // ã‚­ãƒ£ã‚¹ãƒˆåˆ¥å£²ä¸Šæ¨è¨ˆ
  const active = GameState.casts.filter(c => GameState.shifts[c.id]);
  const totals = active.map(c => {
    const statSum = c.aisou + c.kaiwa + c.attentiveness;
    const contrib = Math.max(0, c.fati);
    return {
      id: c.id,
      name: c.name,
      img: c.img,
      contrib: statSum * 0.5 + contrib * 1.5
    };
  });
  const sumContrib = totals.reduce((s, x) => s + x.contrib, 0) || 1;
  const perCastSales = totals.map(x => ({
    ...x,
    sales: Math.floor((GameState.totalSales / GameState.week) * (x.contrib / sumContrib)) // ç°¡æ˜“é…åˆ†
  }));

  // MVPåˆ¤å®šã¨EXPä»˜ä¸
  const mvp = perCastSales.slice().sort((a, b) => b.sales - a.sales)[0];
  GameState.casts.forEach(c => {
    const rec = perCastSales.find(x => x.id === c.id);
    if (!rec) return;
    let expGain = Math.floor(rec.sales / 200);
    if (mvp && mvp.id === c.id) expGain = Math.floor(expGain * 1.5);
    c.exp += expGain;

    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†
    while (c.exp >= 100) {
      c.exp -= 100;
      c.lv += 1;
      c.aisou += randInt(1, 3);
      c.kaiwa += randInt(1, 3);
      c.attentiveness += randInt(1, 3);
      c.fatiMax += randInt(0, 2);
      c.stressMax += randInt(0, 2);
    }

    // ç–²åŠ´ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹å‡¦ç†
  GameState.casts.forEach(c => {
    if(GameState.shifts[c.id]){
      // å‡ºå‹¤ã—ã¦ã„ãŸå ´åˆ â†’ ã‚¹ãƒˆãƒ¬ã‚¹å¢—åŠ 
      c.stress = Math.min(c.stressMax, c.stress + 5);
    } else {
      // ä¼‘ã¿ã ã£ãŸå ´åˆ â†’ ç–²åŠ´å›å¾©ï¼†ã‚¹ãƒˆãƒ¬ã‚¹æ¸›å°‘
      c.fati   = Math.max(0, c.fati -30 );
      c.stress = Math.max(0, c.stress - 5);
    }
  });
    if (c.fati > c.fatiMax) GameState.shifts[c.id] = false;
    if (c.stress >= c.stressMax) {
      if (c.isInitial) {
        GameState.shifts[c.id] = false;
      } else {
        GameState.casts = GameState.casts.filter(x => x.id !== c.id);
      }
    }
 showWeekReport();

  });

  // ãƒ©ãƒ³ã‚¯åˆ¤å®š
  const score = Math.floor(GameState.pop * 0.4 + GameState.rep * 0.4 + (GameState.totalSales / 50000));
  GameState.rankScore = score;
  const step = clamp(Math.floor(score / 25), 0, RankSteps.length - 1);
  GameState.rank = RankSteps[step];

  // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
function showWeekReport(){
  const perCastSales = GameState.perCastSales || [];
  const reportHtml = `
    <div>æœ¬é€±å£²ä¸Šåˆè¨ˆ: <strong>${yen(GameState.totalSales - (GameState.lastReport?.cumTotal || 0))}</strong></div>
    <div>æ¥å®¢æ³¢: ${GameState.waves.length}</div>
    <div>åºƒå‘Šè²»ç”¨: ${yen(GameState.adCost)} ï¼ çµ¦æ–™æ”¯æ‰•: ${yen(salary)}</div>
    <div>è©•åˆ¤: ${GameState.rep} ï¼ çŸ¥ååº¦: ${GameState.pop} ï¼ ãƒ©ãƒ³ã‚¯: ${GameState.rank}</div>
    <h4>ã‚­ãƒ£ã‚¹ãƒˆåˆ¥å£²ä¸Šï¼ˆæ¨è¨ˆï¼‰</h4>
    ${perCastSales.map(x => `
      <div class="row" style="margin:4px 0;">
        <img class="avatar" src="${x.img}">
        <div style="flex:1;">${x.name}</div>
        <div>${yen(x.sales)}</div>
      </div>
    `).join("")}
  `;
  document.getElementById("report").innerHTML = reportHtml;
  GameState.lastReport = { cumTotal: GameState.totalSales };

console.log("reportHtml:", reportHtml);
console.log("report element:", document.getElementById("report"));

 document.querySelectorAll(".phase").forEach(p => p.style.display = "none");
  document.getElementById("phaseResult").style.display = "block";

console.log("phaseResult:", document.getElementById("phaseResult"));

  renderHeader();
  renderCastList();
}
  closeWeekReport();
  // --- å¾ŒåŠï¼šè³‡é‡‘ãƒã‚§ãƒƒã‚¯ãƒ»é€±é€²è¡Œ ---
  if (GameState.funds < 0) {
    openGameOver();
    return;
  }

  GameState.week++;
  if (GameState.week > 52) {
    openEnding(perCastSales);
    return;
  }

  // åºƒå‘Šãƒªã‚»ãƒƒãƒˆ
  GameState.ad = "none";
  GameState.adCost = 0;
  GameState.adEffect = 0;
  document.getElementById("adSelect").value = "none";

  // æ¬¡é€±æº–å‚™
  GameState.shifts = {};
  GameState.assignments = {};
  GameState.waves = generateNextWeekWaves(GameState.rank);
  GameState.waveCursor = 0;

  // ãƒ¬ã‚¢ã‚­ãƒ£ãƒ©åˆ¤å®š
  checkRareEvents();

//ã‚·ãƒ•ãƒˆæ›´æ–°
rollShiftRandom();

// UIæ›´æ–° 
renderHeader();



  // é€±å ±å‘Šãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  const weekMsg = ` 
ã€€ã€€<div class="weekReportModal">
    <h3>ç¬¬${GameState.week-1}é€±ç›®ã®å£²ä¸Š</h3>
    <p>å£²ä¸Š: ${yen(GameState.weekSales)}</p>
    <p>è©•åˆ¤: ${GameState.rep} ï¼ çŸ¥ååº¦: ${GameState.pop} ï¼ ãƒ©ãƒ³ã‚¯: ${GameState.rank}</p>
  `;
  document.getElementById("weekReportPanel").innerHTML = weekMsg;
document.getElementById("weekReportPanel").style.display = "flex"; }

function closeWeekReport(){
  document.getElementById("weekReportModal").style.display = "none";

}


function checkRareEvents(){
  if(!Array.isArray(GameState.waves) || GameState.waves.length === 0){
    return; // wavesãŒæœªå®šç¾©ã‚„ç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
  }
  // ã“ã“ã‹ã‚‰é€šå¸¸å‡¦ç†

 // ã‚«ãƒ¬ãƒ³: åºƒå‘Šåˆ©ç”¨
  if(GameState.ad !== "none" && !GameState.dismissed["ã‚«ãƒ¬ãƒ³"] && !GameState.casts.find(c=>c.name==="ã‚«ãƒ¬ãƒ³")){
    GameState.pendingRare.push("ã‚«ãƒ¬ãƒ³");
  }
  // ãƒ¦ã‚º: ä»Šé€±å£²ä¸ŠãŒ50,000ä»¥ä¸Š
  const weeklySales = GameState.totalSales - (GameState.lastReport?.cumTotal || 0);
  if(weeklySales >= 50000 && !GameState.dismissed["ãƒ¦ã‚º"] && !GameState.casts.find(c=>c.name==="ãƒ¦ã‚º")){
    GameState.pendingRare.push("ãƒ¦ã‚º");
  }
  // ãƒ¬ã‚¤ãƒŠ: ãƒˆãƒ©ãƒ–ãƒ«æˆåŠŸãƒ•ãƒ©ã‚°
  if(GameState.troubleSuccess && !GameState.dismissed["ãƒ¬ã‚¤ãƒŠ"] && !GameState.casts.find(c=>c.name==="ãƒ¬ã‚¤ãƒŠ")){
    GameState.pendingRare.push("ãƒ¬ã‚¤ãƒŠ");
    GameState.troubleSuccess = false; // ãƒªã‚»ãƒƒãƒˆ
  }
  // ãƒŸãƒŠ: æ•™è‚²å®Ÿè¡Œå›æ•°ãŒ3å›ä»¥ä¸Š
  if(GameState.trainCount >= 3 && !GameState.dismissed["ãƒŸãƒŠ"] && !GameState.casts.find(c=>c.name==="ãƒŸãƒŠ")){
    GameState.pendingRare.push("ãƒŸãƒŠ");
    GameState.trainCount = 0; // ãƒªã‚»ãƒƒãƒˆ
  }
  // ã‚¢ã‚ªã‚¤: 20é€±ç›®
  if(GameState.week === 20 && !GameState.dismissed["ã‚¢ã‚ªã‚¤"] && !GameState.casts.find(c=>c.name==="ã‚¢ã‚ªã‚¤")){
    GameState.pendingRare.push("ã‚¢ã‚ªã‚¤");
  }

  if(!Array.isArray(GameState.pendingRare.length) > 0){
    openRareJoinModalIfPending();
  }
}

function openRareJoinModalIfPending(){
  const list = GameState.pendingRare.map(n=> `
    <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
      <img src="${RARE[n].img}" class="avatar" alt="${n}">
      <div><strong>${n}</strong> ãŒåŠ å…¥å¸Œæœ›ã§ã™</div>
    </div>
  `).join('');
  document.getElementById("rareJoinList").innerHTML = list;
  document.getElementById("rareJoinModal").style.display = "flex";
}

function acceptRare(){
  GameState.pendingRare.forEach(n=>{
    GameState.casts.push({...RARE[n]});
  });
  
  document.getElementById("rareJoinModal").style.display = "none";
  renderCastList();
}

function declineRare(){
  GameState.pendingRare.forEach(n=>{
    GameState.dismissed[n] = true;
  });
  GameState.pendingRare = [];
  document.getElementById("rareJoinModal").style.display = "none";
}
  // ãƒ¬ã‚¢ã‚­ãƒ£ãƒ©åˆ¤å®š
  checkRareEvents();

const RARE_MESSAGES = {
  "ã‚«ãƒ¬ãƒ³": "åºƒå‘Šã‚’è¦‹ã¦èˆˆå‘³ã‚’æŒã£ãŸã‚«ãƒ¬ãƒ³ãŒã‚¹ã‚«ã‚¦ãƒˆã«æ¥ã¾ã—ãŸï¼",
  "ãƒ¦ã‚º":   "å£²ä¸Šã«æƒ¹ã‹ã‚Œã¦ãƒ¦ã‚ºãŒåŠ å…¥å¸Œæœ›ã§ã™ï¼",
  "ãƒ¬ã‚¤ãƒŠ": "ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œã‚’è¦‹ã¦ãƒ¬ã‚¤ãƒŠãŒæ„Ÿå¿ƒã—ã€åŠ å…¥ã‚’å¸Œæœ›ï¼",
  "ãƒŸãƒŠ":   "æ•™è‚²ç†±å¿ƒãªå§¿å‹¢ã«ãƒŸãƒŠãŒå…±æ„Ÿã—ã€åŠ å…¥å¸Œæœ›ï¼",
  "ã‚¢ã‚ªã‚¤": "ç¯€ç›®ã®é€±ã«ã‚¢ã‚ªã‚¤ãŒç‰¹åˆ¥åŠ å…¥ï¼"
};

function acceptRare(){
  GameState.pendingRare.forEach(n=>{
    GameState.casts.push({...RARE[n]});
    alert(`${n}ãŒåŠ å…¥ã—ã¾ã—ãŸï¼`); // åŠ å…¥æ¼”å‡º
  });
  GameState.pendingRare = [];
  document.getElementById("rareJoinModal").style.display = "none";
  renderCastList();
}

function declineRare(){
  GameState.pendingRare.forEach(n=>{
    GameState.dismissed[n] = true;
    alert(`${n}ã®åŠ å…¥ã‚’æ–­ã‚Šã¾ã—ãŸâ€¦`); // æ‹’å¦æ¼”å‡º
  });
  GameState.pendingRare = [];
  document.getElementById("rareJoinModal").style.display = "none";
}


function openEnding(perCastSales){
  GameState.ended = true;
  const avgLv = Math.floor(GameState.casts.reduce((s,c)=>s+c.lv,0)/GameState.casts.length);
  const mostService = GameState.casts[0] || null; // ã‚µãƒ¼ãƒ“ã‚¹æ•°ã‚’ç®¡ç†ã—ã¦ã„ãªã„ãŸã‚ç°¡æ˜“
  const topSales = perCastSales.slice().sort((a,b)=>b.sales-a.sales)[0];

  document.getElementById("endingSummary").innerHTML = `
    <div>ç´¯è¨ˆç·å£²ä¸Š: <strong>${yen(GameState.totalSales)}</strong></div>
    <div>åº—èˆ—ãƒ©ãƒ³ã‚¯: <strong>${GameState.rank}</strong> ï¼ è©•åˆ¤: ${GameState.rep} ï¼ çŸ¥ååº¦: ${GameState.pop}</div>
    <div>ã‚­ãƒ£ã‚¹ãƒˆå¹³å‡Lv: <strong>${avgLv}</strong></div>
    <div>æœ€ã‚‚æ¥å®¢ã—ãŸã‚­ãƒ£ã‚¹ãƒˆï¼ˆå‚è€ƒï¼‰: ${mostService?mostService.name:'â€”'}</div>
    <div>å£²ä¸Šãƒˆãƒƒãƒ—ã‚­ãƒ£ã‚¹ãƒˆ: ${topSales?topSales.name:'â€”'}</div>
  `;
  document.getElementById("endingCastList").innerHTML = GameState.casts.map(c=>`
    <div class="row" style="margin:4px 0;">
      <img class="avatar" src="${c.img}">
      <div style="flex:1;">
        <strong>${c.name}</strong> Lv${c.lv}ï¼æ„›æƒ³:${c.aisou} ä¼šè©±:${c.kaiwa} æ°—é£ã„:${c.attentiveness}
      </div>
      <div>ç–²åŠ´:${c.fati}/${c.fatiMax} ã‚¹ãƒˆãƒ¬ã‚¹:${c.stress}/${c.stressMax}</div>
    </div>
  `).join("");
  document.getElementById("endingModal").style.display = "flex";
}
document.getElementById("btnCloseEnding").onclick = ()=>document.getElementById("endingModal").style.display="none";

function openGameOver(){
  document.getElementById("gameoverCastList").innerHTML = GameState.casts.map(c=>`
    <div class="row" style="margin:4px 0;">
      <img class="avatar" src="${c.img}">
      <div style="flex:1;"><strong>${c.name}</strong> Lv${c.lv}</div>
      <div>ç–²åŠ´:${c.fati}/${c.fatiMax} ã‚¹ãƒˆãƒ¬ã‚¹:${c.stress}/${c.stressMax}</div>
    </div>`).join("");
  document.getElementById("gameoverModal").style.display = "flex";
}
document.getElementById("btnCloseGameover").onclick = ()=>document.getElementById("gameoverModal").style.display="none";

/* ===========
   ãƒªã‚»ãƒƒãƒˆ
   =========== */
document.getElementById("btnReset").onclick = ()=>{ initGame(); document.getElementById("endingModal").style.display="none"; };
document.getElementById("btnReset2").onclick = ()=>{ initGame(); document.getElementById("gameoverModal").style.display="none"; };

</script>
</body>
</html>





